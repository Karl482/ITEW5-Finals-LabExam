# Service Worker Implementation

This document describes the Service Worker implementation using Workbox for the Sports PWA Task Manager.

## Overview

The application uses Workbox (via vite-plugin-pwa) to implement a robust service worker with caching strategies for offline functionality and improved performance.

## Features

### 1. Automatic Registration
- Service worker is automatically registered on app load
- Registration happens in `src/main.tsx`
- Uses `workbox-window` for lifecycle management

### 2. Caching Strategies

#### Cache-First (Static Assets)
- **Google Fonts**: Cached for 1 year
- **Images** (png, jpg, jpeg, svg, gif, webp): Cached for 30 days
- **Purpose**: Fast loading of static resources

#### Stale-While-Revalidate (JS/CSS)
- **JavaScript and CSS files**: Cached for 7 days
- **Purpose**: Instant loading while updating in background

#### Network-First with Cache Fallback (API Calls)
- **API endpoints** (`/api/*`): Network timeout of 10 seconds
- **Cache duration**: 5 minutes
- **Purpose**: Always try to get fresh data, fall back to cache if offline

### 3. Update Handling

The app includes a sophisticated update mechanism:

#### ServiceWorkerUpdate Component
- Displays a banner when a new version is available
- Allows users to update immediately or dismiss
- Sports-themed styling with trophy icon
- Automatically reloads the page after update

#### Update Flow
1. New service worker is detected
2. Banner appears at bottom of screen
3. User clicks "Update Now"
4. Service worker skips waiting
5. Page reloads with new content

### 4. Offline Support

The service worker enables:
- Offline access to previously visited pages
- Cached API responses when network is unavailable
- Automatic sync when connection is restored (implemented in Task 22)

## Configuration

### Vite Configuration (`vite.config.js`)

```javascript
VitePWA({
  registerType: 'autoUpdate',
  workbox: {
    runtimeCaching: [
      // Cache strategies defined here
    ],
    cleanupOutdatedCaches: true,
    skipWaiting: true,
    clientsClaim: true
  }
})
```

### Key Options

- **registerType: 'autoUpdate'**: Automatically update service worker
- **skipWaiting: true**: New service worker activates immediately
- **clientsClaim: true**: Take control of all pages immediately
- **cleanupOutdatedCaches: true**: Remove old caches automatically

## Files

### Core Files
- `src/serviceWorkerRegistration.ts`: Registration and lifecycle management
- `src/components/ServiceWorkerUpdate.tsx`: Update notification UI
- `src/components/ServiceWorkerUpdate.css`: Update banner styling
- `vite.config.js`: Workbox configuration

### Generated Files (Build Time)
- `dist/sw.js`: The actual service worker (generated by Workbox)
- `dist/workbox-*.js`: Workbox runtime libraries

## Usage

### Registering the Service Worker

The service worker is automatically registered in `main.tsx`:

```typescript
registerServiceWorker({
  onSuccess: (registration) => {
    console.log('Service worker registered successfully');
  },
  onUpdate: (registration) => {
    console.log('New content is available');
  },
  onOfflineReady: () => {
    console.log('App is ready to work offline');
  },
  onNeedRefresh: () => {
    console.log('New content available, click to refresh');
  }
});
```

### Manually Triggering Updates

```typescript
import { updateServiceWorker, checkForUpdates } from './serviceWorkerRegistration';

// Check for updates
await checkForUpdates();

// Apply pending update
updateServiceWorker();
```

### Unregistering (for development)

```typescript
import { unregisterServiceWorker } from './serviceWorkerRegistration';

unregisterServiceWorker();
```

## Development

### Testing in Development

By default, the service worker is disabled in development mode. To enable it:

1. Set environment variable: `VITE_SW_DEV=true`
2. Or modify `vite.config.js` to set `devOptions.enabled: true`

### Debugging

1. Open Chrome DevTools → Application → Service Workers
2. Check "Update on reload" for development
3. Use "Unregister" to clear the service worker
4. Check "Offline" to simulate offline mode

### Cache Inspection

1. Chrome DevTools → Application → Cache Storage
2. View cached resources by cache name:
   - `google-fonts-cache`
   - `gstatic-fonts-cache`
   - `images-cache`
   - `static-resources`
   - `api-cache`

## Production Build

```bash
npm run build
```

The build process:
1. Compiles TypeScript and React
2. Generates optimized bundles
3. Creates service worker with Workbox
4. Precaches critical assets
5. Generates manifest.json

## Testing Offline Functionality

1. Build the app: `npm run build`
2. Serve the build: `npm run preview`
3. Open in browser and load the app
4. Open DevTools → Network → Set to "Offline"
5. Refresh the page - it should still work!
6. Navigate between pages - cached pages load instantly

## Browser Support

Service workers are supported in:
- Chrome 40+
- Firefox 44+
- Safari 11.1+
- Edge 17+

The app gracefully degrades in browsers without service worker support.

## Performance Benefits

- **First Load**: Assets are cached for instant subsequent loads
- **Offline Access**: Previously visited pages work offline
- **Background Updates**: New versions download in background
- **Reduced Server Load**: Cached resources don't hit the server
- **Faster Navigation**: Instant page loads from cache

## Security

- Service workers only work over HTTPS (or localhost)
- Scope is limited to the app's origin
- Cannot access cookies or localStorage directly
- All cached responses are validated

## Troubleshooting

### Service Worker Not Registering
- Check browser console for errors
- Ensure HTTPS (or localhost)
- Verify `sw.js` is accessible at `/sw.js`

### Updates Not Appearing
- Hard refresh (Ctrl+Shift+R)
- Clear service worker in DevTools
- Check "Update on reload" in DevTools

### Cache Issues
- Clear cache storage in DevTools
- Unregister and re-register service worker
- Check cache names in configuration

## Related Requirements

This implementation satisfies:
- **Requirement 3.3**: Service worker registration
- **Requirement 3.4**: Asset caching
- **Requirement 4.1**: Offline functionality

## Next Steps

- Task 21: Implement offline detection and cached content serving
- Task 22: Implement offline operation queueing and synchronization
- Task 23: Add PWA installation prompt
